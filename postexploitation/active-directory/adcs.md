---
title: Active Directory Certificate Services
description: 
published: true
date: 2021-10-05T14:49:14.907Z
tags: active directory, certificates, adcs
editor: markdown
dateCreated: 2021-08-08T01:18:54.704Z
---

# Active Directory Certificate Services (ADCS)

## Certified Pre-Owned

- Blog Post: https://posts.specterops.io/certified-pre-owned-d95910965cd2
- White Paper: https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf
- Talk Slides: https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Certified-Pre-Owned-Abusing-Active-Directory-Certificate-Services.pdf
- Tools (Original Research Source):
  - Certify - https://github.com/GhostPack/Certify
  - PSPKIAudit - https://github.com/GhostPack/PSPKIAudit
  - ForgeCert - https://github.com/GhostPack/ForgeCert
- Tools (Exterior):
	- Certi - https://github.com/zer1t0/certi
	- PKINITTools - https://github.com/dirkjanm/PKINITtools
	- NTLMRelayX (Impacket) Pull Request \#1101 - https://github.com/SecureAuthCorp/impacket/pull/1101
	- ADCSPwn - https://github.com/bats3c/ADCSPwn
- Attacks: (details pulled from slides)
  - [ESC1](/postexploitation/active-directory/adcs/esc1)
	  - General Requirements
	  - \[PKINIT\] Client Authentication, Smart Card Logon, Any Purpose, or No EKU (i.e., EKU allows auth)
	  - The **ENROLLEE_SUPPLIES_SUBJECT** flag
  - [ESC2](/postexploitation/active-directory/adcs/esc2)
	  - General requirements
	  - The Any Puprose EKU or No EKU
  - [ESC3](/postexploitation/active-directory/adcs/esc3)
	  - General requirements + no "enrollment agent restrictions"
	  - The **Certificate Request Agent** EKU
	  - Enrollment rights to template with a few other requirements
  - [ESC4](/postexploitation/active-directory/adcs/esc4)
	  - Vulnerable certificate template access control
  - [ESC5](/postexploitation/active-directory/adcs/esc5)
	  - Vulnerable PKI object access control
  - [ESC6](/postexploitation/active-directory/adcs/esc6)
	  - **EDITF_ATTRIBUTESUBJECTALTNAME2** flag set on CA
	  - (Allows CSRs for ANY template to specify a SAN!)
  - [ESC7](/postexploitation/active-directory/adcs/esc7)
	  - Vulnerable CA access control
	  - The **ManageCA** permission can be used to fixate ESC6
  - [ESC8](/postexploitation/active-directory/adcs/esc8)
	  - NTLM Relay to HTTP Enrolllment Endpoints


## Requesting Exportable Certificate



## Request {.tabset}

Source: https://stackoverflow.com/a/63201131

### INF File

Create a request INF file. There are a lot of attributes that you can apply to the request. This is where all of the functionality of the certificate will go, the key length, the subject name, etc, but all of that will mostly be filled in by the the template anyways.


```file request.inf
[NewRequest]
Exportable = TRUE
[RequestAttributes]
CertificateTemplate = "User"
```

### REQ File

Create the request file from the INF configuration:
```
certreq -new request.inf request.req
```

### CER File

Submit the certificate to the designated Certificate Authority. If you do not specify one, then a pop up will happen so that you may select one from the list. This is not very stealthy ;-)
```
certreq -submit -config CAHostName\CAName request.req request.cer
```
### Accept Cert

Accept the new certificate into the certificate store of the current user. This isn't a required step but does help when exporting to get a complete certificate chain.
```
certreq -accept temp.cer
```

## Using Certificates

**Listing certificates:**
```
certutil -store my
```

**Exporting it with Powershell:**
You do need to get the $Thumbprint of the certificate you want first. You can do that with `gci cert:\LocalMachine\My\` then selecting the certificate you wish to export from the list.
```
$mypwd = ConvertTo-SecureString -String $password -Force -AsPlainText
Export-PfxCertificate -Cert cert:\LocalMachine\My\$Thumbprint -FilePath C:\corey.com.pfx -Password $mypwd
```
